name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: dnf install -y rpm-build python3 gettext

      - name: Get version
        id: version
        run: |
          VER=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Build RPM
        run: |
          PKG="wifi-analyzer"
          PYNAME="wifi_analyzer"
          VER="${{ steps.version.outputs.version }}"

          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          tar czf ~/rpmbuild/SOURCES/${{PKG}}-${{VER}}.tar.gz --transform "s,^,${{PKG}}-${{VER}}/," \
            $(ls -d src/${{PYNAME}} ${{PYNAME}} po data pyproject.toml *.desktop *.metainfo.xml 2>/dev/null)

          cat > ~/rpmbuild/SPECS/${{PKG}}.spec << 'SPEC'
Name:           wifi-analyzer
Version:        VPLACEHOLDER
Release:        1
Summary:        WiFi network analyzer
License:        GPL-3.0
URL:            https://github.com/yeager/wifi-analyzer
Source0:        %{name}-%{version}.tar.gz
BuildArch:      noarch
Requires:       python3 >= 3.9
Requires:       gtk4
Requires:       libadwaita

%description
WiFi network analyzer

%prep
%setup -q

%install
PYNAME="wifi_analyzer"
mkdir -p %{buildroot}/usr/lib/python3/dist-packages/$PYNAME
if [ -d "src/$PYNAME" ]; then
  cp -r src/$PYNAME/* %{buildroot}/usr/lib/python3/dist-packages/$PYNAME/
elif [ -d "$PYNAME" ]; then
  cp -r $PYNAME/* %{buildroot}/usr/lib/python3/dist-packages/$PYNAME/
fi

mkdir -p %{buildroot}/usr/bin
cat > %{buildroot}/usr/bin/%{name} << 'WRAPPER'
#!/usr/bin/python3
import sys
from wifi_analyzer.main import main
sys.exit(main())
WRAPPER
chmod 755 %{buildroot}/usr/bin/%{name}

mkdir -p %{buildroot}/usr/share/applications
mkdir -p %{buildroot}/usr/share/metainfo
mkdir -p %{buildroot}/usr/share/icons/hicolor/scalable/apps
for f in data/*.desktop *.desktop; do
  [ -f "$f" ] && install -m 644 "$f" %{buildroot}/usr/share/applications/
done
for f in data/*.metainfo.xml *.metainfo.xml; do
  [ -f "$f" ] && install -m 644 "$f" %{buildroot}/usr/share/metainfo/
done
find data/icons -name "*.svg" -exec install -m 644 {} %{buildroot}/usr/share/icons/hicolor/scalable/apps/ \; 2>/dev/null || true

for po in po/*.po; do
  [ -f "$po" ] || continue
  lang=$(basename "$po" .po)
  mkdir -p %{buildroot}/usr/share/%{name}/locale/$lang/LC_MESSAGES
  msgfmt -o %{buildroot}/usr/share/%{name}/locale/$lang/LC_MESSAGES/%{name}.mo "$po"
done

%files
/usr/bin/%{name}
/usr/lib/python3/dist-packages/wifi_analyzer/
/usr/share/applications/
/usr/share/metainfo/
/usr/share/icons/
/usr/share/%{name}/
SPEC
          sed -i "s/VPLACEHOLDER/$VER/" ~/rpmbuild/SPECS/${{PKG}}.spec

          rpmbuild -bb ~/rpmbuild/SPECS/${{PKG}}.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload RPM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER=${{ steps.version.outputs.version }}
          RPM=$(ls *.rpm | head -1)
          gh release upload "v${{VER}}" "$RPM" --clobber 2>/dev/null || \
          gh release upload "${{GITHUB_REF_NAME}}" "$RPM" --clobber 2>/dev/null || true
