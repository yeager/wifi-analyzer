name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: dnf install -y rpm-build python3 gettext findutils tar gzip

      - name: Get version
        id: version
        run: |
          VER=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Build RPM
        run: |
          PKG="wifi-analyzer"
          VER="${{ steps.version.outputs.version }}"

          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          tar czf ~/rpmbuild/SOURCES/${PKG}-${VER}.tar.gz \
            --transform "s,^,${PKG}-${VER}/," \
            $(ls -d src/wifi_analyzer wifi_analyzer po data pyproject.toml *.desktop *.metainfo.xml 2>/dev/null)

          echo "TmFtZTogICAgICAgICAgIHdpZmktYW5hbHl6ZXIKVmVyc2lvbjogICAgICAgIFZFUlNJT05QTEFDRUhPTERFUgpSZWxlYXNlOiAgICAgICAgMQpTdW1tYXJ5OiAgICAgICAgV2lGaSBuZXR3b3JrIGFuYWx5emVyCkxpY2Vuc2U6ICAgICAgICBHUEwtMy4wClVSTDogICAgICAgICAgICBodHRwczovL2dpdGh1Yi5jb20veWVhZ2VyL3dpZmktYW5hbHl6ZXIKU291cmNlMDogICAgICAgICV7bmFtZX0tJXt2ZXJzaW9ufS50YXIuZ3oKQnVpbGRBcmNoOiAgICAgIG5vYXJjaApSZXF1aXJlczogICAgICAgcHl0aG9uMyA+PSAzLjkKUmVxdWlyZXM6ICAgICAgIGd0azQKUmVxdWlyZXM6ICAgICAgIGxpYmFkd2FpdGEKCiVkZXNjcmlwdGlvbgpXaUZpIG5ldHdvcmsgYW5hbHl6ZXIKCiVwcmVwCiVzZXR1cCAtcQoKJWluc3RhbGwKUFlOQU1FPSJ3aWZpX2FuYWx5emVyIgpta2RpciAtcCAle2J1aWxkcm9vdH0vdXNyL2xpYi9weXRob24zL2Rpc3QtcGFja2FnZXMvJFBZTkFNRQppZiBbIC1kICJzcmMvJFBZTkFNRSIgXTsgdGhlbgogIGNwIC1yIHNyYy8kUFlOQU1FLyogJXtidWlsZHJvb3R9L3Vzci9saWIvcHl0aG9uMy9kaXN0LXBhY2thZ2VzLyRQWU5BTUUvCmVsaWYgWyAtZCAiJFBZTkFNRSIgXTsgdGhlbgogIGNwIC1yICRQWU5BTUUvKiAle2J1aWxkcm9vdH0vdXNyL2xpYi9weXRob24zL2Rpc3QtcGFja2FnZXMvJFBZTkFNRS8KZmkKCm1rZGlyIC1wICV7YnVpbGRyb290fS91c3IvYmluCmNhdCA+ICV7YnVpbGRyb290fS91c3IvYmluLyV7bmFtZX0gPDwgJ0xBVU5DSEVSJwojIS91c3IvYmluL3B5dGhvbjMKaW1wb3J0IHN5cwpmcm9tIHdpZmlfYW5hbHl6ZXIubWFpbiBpbXBvcnQgbWFpbgpzeXMuZXhpdChtYWluKCkpCkxBVU5DSEVSCmNobW9kIDc1NSAle2J1aWxkcm9vdH0vdXNyL2Jpbi8le25hbWV9Cgpta2RpciAtcCAle2J1aWxkcm9vdH0vdXNyL3NoYXJlL2FwcGxpY2F0aW9ucwpta2RpciAtcCAle2J1aWxkcm9vdH0vdXNyL3NoYXJlL21ldGFpbmZvCm1rZGlyIC1wICV7YnVpbGRyb290fS91c3Ivc2hhcmUvaWNvbnMvaGljb2xvci9zY2FsYWJsZS9hcHBzCmZvciBmIGluIGRhdGEvKi5kZXNrdG9wICouZGVza3RvcDsgZG8KICBbIC1mICIkZiIgXSAmJiBpbnN0YWxsIC1tIDY0NCAiJGYiICV7YnVpbGRyb290fS91c3Ivc2hhcmUvYXBwbGljYXRpb25zLwpkb25lCmZvciBmIGluIGRhdGEvKi5tZXRhaW5mby54bWwgKi5tZXRhaW5mby54bWw7IGRvCiAgWyAtZiAiJGYiIF0gJiYgaW5zdGFsbCAtbSA2NDQgIiRmIiAle2J1aWxkcm9vdH0vdXNyL3NoYXJlL21ldGFpbmZvLwpkb25lCmZpbmQgZGF0YS9pY29ucyAtbmFtZSAiKi5zdmciIC1wcmludDAgMj4vZGV2L251bGwgfCB4YXJncyAtMCAtSXt9IGluc3RhbGwgLW0gNjQ0IHt9ICV7YnVpbGRyb290fS91c3Ivc2hhcmUvaWNvbnMvaGljb2xvci9zY2FsYWJsZS9hcHBzLyAyPi9kZXYvbnVsbCB8fCB0cnVlCgpmb3IgcG8gaW4gcG8vKi5wbzsgZG8KICBbIC1mICIkcG8iIF0gfHwgY29udGludWUKICBsYW5nPSQoYmFzZW5hbWUgIiRwbyIgLnBvKQogIG1rZGlyIC1wICV7YnVpbGRyb290fS91c3Ivc2hhcmUvJXtuYW1lfS9sb2NhbGUvJGxhbmcvTENfTUVTU0FHRVMKICBtc2dmbXQgLW8gJXtidWlsZHJvb3R9L3Vzci9zaGFyZS8le25hbWV9L2xvY2FsZS8kbGFuZy9MQ19NRVNTQUdFUy8le25hbWV9Lm1vICIkcG8iCmRvbmUKCiVmaWxlcwovdXNyL2Jpbi8le25hbWV9Ci91c3IvbGliL3B5dGhvbjMvZGlzdC1wYWNrYWdlcy93aWZpX2FuYWx5emVyLwovdXNyL3NoYXJlL2FwcGxpY2F0aW9ucy8KL3Vzci9zaGFyZS9tZXRhaW5mby8KL3Vzci9zaGFyZS9pY29ucy8KL3Vzci9zaGFyZS8le25hbWV9Lwo=" | base64 -d | sed "s/VERSIONPLACEHOLDER/$VER/" > ~/rpmbuild/SPECS/${PKG}.spec

          rpmbuild -bb ~/rpmbuild/SPECS/${PKG}.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload RPM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER="${{ steps.version.outputs.version }}"
          RPM=$(ls *.rpm | head -1)
          gh release upload "v${VER}" "$RPM" --clobber 2>/dev/null || \
          gh release upload "${{ github.ref_name }}" "$RPM" --clobber 2>/dev/null || true
